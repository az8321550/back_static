
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>数字营销平台</title><link rel="shortcut icon" href="../static/images/favicon.ico">
    <link href="../static/plugins/bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="../static/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../static/plugins/jquery-jqgrid/ui.jqgrid.css" rel="stylesheet" />
    <link href="../static/styles/base.css" rel="stylesheet" />
    <link href="../static/styles/setting.css" rel="stylesheet" />
    <link href="../static/plugins/jquery-nestable/jquery.nestable.css" rel="stylesheet" />
</head>
<body>
    <div class="sider">
        <div class="home-menu">
            <a href="index.html">
                <i class="icon icon-home"></i>
            </a>
        </div>
        <div class="main-name">
            数字营销平台
        </div>
        <div class="user clearfix">
            <img src="../static/images/header.png" />
            Admin_Super
        </div>
        <ul class="menu">
            <li><a href="setting.html">用户管理</a></li>
            <li><a href="rolemanage.html">角色管理</a></li>
            <li class="active"><a href="rolemenu.html">菜单管理</a></li>
            <li><a href="menubutton.html">按钮管理</a></li>
            <li><a href="roleedit.html">权限配置</a></li>
            <li><a href="rolewarning.html">权限异常</a></li>
        </ul>
        <ul class="menu set-menu">
            <li><a href="list.html">营销中心</a></li>
            <li><a href="taglist.html">会员中心</a></li>
            <li><a href="tmplactive.html">模板中心</a></li>
            <li><a href="waylist.html">渠道中心</a></li>
        </ul>
    </div>
    <div class="content">
        <div class="clearfix">
            <div class="col-xs-12">
                <div id="list-top">
                    <div class="breadcrumb-con">
                        <ol class="breadcrumb">
                            <li><a href="index.html"><i class="icon icon-home"></i></a></li>
                            <li><a href="#">常规业务</a></li>
                            <li><a href="#">系统配置</a></li>
                            <li class="active">菜单管理</li>
                        </ol>
                        <div class="search-con">
                            <form>
                                <input class="text" type="text" placeholder="快速检索" />
                                <button class="button"><i class="icon icon-search"></i></button>
                            </form>
                        </div>
                    </div>
                    <div class="content-title clearfix mb20 search-quick">
                        <span class="title fontblue">菜单管理</span>
                        <div class="group-small clearfix">
                            <a href="#" class="btn btn-warning btn-sm" data-toggle="dialog" data-target="#main-dialog">新建</a>
                            <a href="#" class="btn btn-default btn-sm" id="edit">编辑</a>
                            <a href="#" id="btn-delete" class="btn btn-default btn-sm">删除</a>
                            <div class="dropdown" style="display:inline-block;">
                                <a role="button" class="btn btn-default btn-sm" data-toggle="dropdown" href="#">状态 <b class="caret"></b></a>
                                <ul class="dropdown-menu" role="menu">
                                    <li><a tabindex="-1" href="#" id="status_true">启用</a></li>
                                    <li><a tabindex="-1" href="#" id="status_false">停用</a></li>
                                </ul>
                            </div>
                            <a href="rolequick.html" class="btn btn-success btn-sm">快速入口</a>
                        </div>
                    </div>
                </div>
                <textarea id="list_data" style="display:none;" class="form-control"></textarea>
                <div class="dd-con">
                    <div class="dd" id="menu_list"></div>
                </div>
            </div>
        </div>

    </div>

    <div class="main-dialog" id="main-dialog">
        <div class="event-manage">
            <div class="col-xs-12">
                <div class="event-top clearfix">
                    <div class="event-icon">
                        <i class="icon icon-reorder"></i>
                    </div>
                    <div class="title">
                        新建菜单
                    </div>
                </div>
                <form class="form-horizontal pt20" id="main-form">
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuparent">上级菜单：</label>
                        <div class="col-md-10">
                            <select class="form-control" id="menuparent" name="menuparent">
                                <option value="1">+顶级菜单</option>
                                <option value="2">-下级菜单</option>
                            </select>
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuname">菜单名称：</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="menuname" id="menuname" />
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuurl">菜单url：</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" id="menuurl" name="menuurl" />
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-1 col-md-11 mybtn">
                            <div class="pull-right">
                                <button class="btn btn-success">新建</button>
                                <button class="btn btn-default" type="button" data-toggle="dialog-close">返回</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="main-dialog" id="main-dialog2">
        <div class="event-manage">
            <div class="col-xs-12">
                <div class="event-top clearfix">
                    <div class="event-icon">
                        <i class="icon icon-reorder"></i>
                    </div>
                    <div class="title">
                        修改菜单
                    </div>
                </div>
                <form class="form-horizontal pt20" id="main-form">
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuparent">上级菜单：</label>
                        <div class="col-md-10">
                            <select class="form-control" id="menuparent" name="menuparent">
                                <option>+顶级菜单</option>
                                <option>-下级菜单</option>
                            </select>
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuname">菜单名称：</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" name="menuname" id="menuname" />
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-2 control-label" for="menuurl">菜单url：</label>
                        <div class="col-md-10">
                            <input type="text" class="form-control" id="menuurl" name="menuurl" />
                            <span class="required">*</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-offset-1 col-md-11 mybtn">
                            <div class="pull-right">
                                <button class="btn btn-success">保存</button>
                                <button class="btn btn-default" type="button" data-toggle="dialog-close">返回</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="../static/plugins/jquery/jquery.js"></script>
    <script src="../static/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="../static/plugins/jquery-mockjax/jquery.mockjax.js"></script>
    <script src="../static/plugins/bootstrap-bootbox/bootbox.js"></script>
    <script src="../static/plugins/jquery-jqgrid/jquery.jqGrid.js"></script>
    <script src="../static/plugins/jquery-validation/1.9.0/jquery.validate.min.js"></script>
    <script src="../static/plugins/jquery-nestable/jquery.nestable.js"></script>
    <script src="../static/scripts/app.js"></script><!--[if lt IE 9]>
    <script src="../static/plugins/respond/respond.min.js"></script>
    <script src="../static/plugins/html5shiv/html5shiv.min.js"></script><![endif]-->
    <script>
        !function () {

            //验证
            $("#main-form").validate({
                rules: {
                    menuname: {
                        required: true
                    },
                    menuurl: {
                        required: true
                    }
                },
                messages: {
                    menuname: {
                        required: "请输入菜单名称"
                    },
                    menuurl: {
                        required: "请输入菜单url链接"
                    }
                },
                submitHandler: function () {

                }
            });

            

            $(document).on("mousedown", ".dd-handle", function () {
                $(".dd-handle.active").removeClass("active");
                $(this).addClass("active");
            });

            $("#edit").click(function (e) {
                if ($(".dd-handle.active").length) {
                    app.showDialog("#main-dialog2");
                }
                else {
                    bootbox.alert("请先选择要编辑的数据")
                }
                return false;
            });

            var menuData = [{ "id": "287", "nameZh": "营销门户", "resourceUrl": "", "status": "1", "children": [{ "id": "3", "nameZh": "系统管理", "resourceUrl": "", "status": "1", "children": [{ "id": "7", "nameZh": "用户管理", "resourceUrl": "/management/sysuser", "status": "1" }, { "id": "6", "nameZh": "角色管理", "resourceUrl": "/management/sysrole", "status": "1" }, { "id": "5", "nameZh": "菜单管理", "resourceUrl": "/management/sysresource", "status": "1" }, { "id": "275", "nameZh": "按钮管理", "resourceUrl": "/management/sysFunction", "status": "1" }, { "id": "20", "nameZh": "日志管理", "resourceUrl": "/management/log", "status": "0" }, { "id": "31", "nameZh": "数据权限", "resourceUrl": "/management/dataright", "status": "1" }, { "id": "14", "nameZh": "基础信息", "resourceUrl": "/management/sysbasetype", "status": "0" }, { "id": "25", "nameZh": "职位管理", "resourceUrl": "/management/sysposition", "status": "0" }, { "id": "15", "nameZh": "机构管理", "resourceUrl": "/management/sysorganize", "status": "0" }] }, { "id": "91", "nameZh": "活动核对中心", "resourceUrl": "", "status": "0" }, { "id": "2", "nameZh": "报表中心", "resourceUrl": "", "status": "0" }, { "id": "261", "nameZh": "渠道中心", "resourceUrl": "", "status": "1", "children": [{ "id": "262", "nameZh": "渠道管理", "resourceUrl": "/dmp/channel/goChannelPage", "status": "1" }] }, { "id": "264", "nameZh": "模版中心", "resourceUrl": "", "status": "1", "children": [{ "id": "265", "nameZh": "活动模版", "resourceUrl": "/dmp/template/goTemplatePage", "status": "1" }, { "id": "266", "nameZh": "模版分类", "resourceUrl": "/dmp/template/goTemplateCategoryPage", "status": "1" }, { "id": "267", "nameZh": "模版参数", "resourceUrl": "/dmp/template/goTemplateParameterPage", "status": "1" }] }, { "id": "268", "nameZh": "营销中心", "resourceUrl": "", "status": "1", "children": [{ "id": "278", "nameZh": "营销活动", "resourceUrl": "/dmp/marketing/goMarketingPage", "status": "1" }, { "id": "269", "nameZh": "业务类型", "resourceUrl": "/dmp/marketing/goMarketingActPage", "status": "1" }, { "id": "298", "nameZh": "22", "resourceUrl": "22", "status": "1" }, { "id": "303", "nameZh": "活动任务", "resourceUrl": "/marketingtask/activelist", "status": "1" }] }, { "id": "90", "nameZh": "优惠券", "resourceUrl": "", "status": "0" }, { "id": "1", "nameZh": "促销中心", "resourceUrl": "", "status": "0" }, { "id": "299", "nameZh": "会员中心", "resourceUrl": "", "status": "1", "children": [{ "id": "301", "nameZh": "标签管理", "resourceUrl": "/dmp/tag", "status": "1" }, { "id": "302", "nameZh": "指标管理", "resourceUrl": "/dmp/norm", "status": "1" }] }] }, { "id": "305", "nameZh": "123", "resourceUrl": "123", "status": "0", "children": [{ "id": "306", "nameZh": "122", "resourceUrl": "122", "status": "0" }, { "id": "304", "nameZh": "2222", "resourceUrl": "222", "status": "1" }] }];

            var htmlArr = [];

            var initForeach = function (data) {
                htmlArr.push('<ol class="dd-list">');
                for (var i = 0; i < data.length; i++) {
                    if (data[i].status=="0") {
                        htmlArr.push('<li class="dd-item" data-name="' + data[i].nameZh + '" data-id="' + data[i].id + '"><div class="dd-handle">' + data[i].nameZh + ' <span class="menu_url">' + data[i].resourceUrl + '</span></div>');
                    } else {
                        htmlArr.push('<li class="dd-item" data-name="' + data[i].nameZh + '" data-id="' + data[i].id + '"><div class="dd-handle">' + data[i].nameZh + ' <span class="menu_url">' + data[i].resourceUrl + '</span><span class="menu_statu">已停用</span></div>');
                    }
                    if (data[i].children)
                        initForeach(data[i].children);
                    htmlArr.push('</li>');
                }
                htmlArr.push('</ol>');
            }

            var initMenu = function (data) {
                
                initForeach(menuData);
                $("#menu_list").append(htmlArr.join(""))
                
                var updateOutput = function (e) {
                    var list = e.length ? e : $(e.target),
                        output = list.data('output');
                    if ($("#list_data").val()&&$("#list_data").val() != window.JSON.stringify(list.nestable('serialize'))) {
                        //拖动改变事件
                        //console.log($(".dd-handle.active").parent().data("id"));

                        //父id的值
                        var tempResult = 0,
                            tempSibing = 0,//下一个兄弟
                            tempNode = $(".dd-handle.active").parent(),
                            tempParent = tempNode.parent().parent();
                        if (tempParent.hasClass("dd-item")) {
                            tempResult = tempParent.data("id");
                        }
                        tempSibing = tempNode.next().data("id")||0;
                        console.log(tempSibing);
                    }
                    output.val(window.JSON.stringify(list.nestable('serialize')));
                };


                $('#menu_list').nestable({
                    group: 1
                }).on('change', updateOutput);

                updateOutput($('#menu_list').data('output', $('#list_data')));

                //返回json结果为$('#list_data').val()

                $('.dd').nestable('collapseAll');

                //默认展开第一节
                $("#menu_list>.dd-list>.dd-item:first>button[data-action=expand]").click();
            }();


            $("#btn-delete").click(function () {
                var _this = $(".dd-handle.active").parent();
                if (_this.siblings().length == 0) {
                    _this.parent().parent().children("button").hide().siblings(".dd-list").remove();
                }
                _this.remove();

            });

            //$('#menu_list').on('change', function () {
            //    //拖动改变事件
            //    //console.log($(".dd-handle.active").parent().data("id"));
            //});

            //$("#status_true").click(function () {
            //    $(".dd-handle.active").find(".menu_statu").remove();
            //});

            //$("#status_false").click(function () {
            //    if ($(".dd-handle.active").find(".menu_statu").length)
            //        return;
            //    $(".dd-handle.active").append('<span class="menu_statu">已停用</span>');
            //    console.log(list)
            //});

        }();
    </script>
</body>
</html>
